<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Pilkades 2026 - Voting Resmi</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    
    <!-- Library yang dibutuhkan -->
    <script src="https://cdn.ethers.io/lib/ethers-6.13.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.2.0/crypto-js.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', sans-serif;
            background: #000;
            color: #fff;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }
        .card {
            background: #111;
            width: 100%;
            max-width: 440px;
            border-radius: 28px;
            padding: 36px 28px;
            box-shadow: 0 20px 60px rgba(255, 107, 0, 0.25);
            border: 1px solid rgba(255, 107, 0, 0.15);
            position: relative;
            overflow: hidden;
        }
        .card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; height: 4px;
            background: linear-gradient(90deg, #ff6b00, #ff9f43);
        }
        h1 {
            font-size: 2.4em;
            text-align: center;
            margin-bottom: 8px;
            color: #ff6b00;
            text-shadow: 0 0 20px rgba(255, 107, 0, 0.4);
        }
        .subtitle {
            text-align: center;
            font-size: 1.15em;
            opacity: 0.9;
            margin-bottom: 24px;
        }
        .steps {
            background: rgba(255, 107, 0, 0.08);
            border: 1px solid rgba(255, 107, 0, 0.2);
            padding: 20px;
            border-radius: 18px;
            font-size: 1.02em;
            line-height: 1.85;
            text-align: left;
            margin: 24px 0;
        }
        .steps b { color: #ff9f43; }

        .seed-locked {
            background: linear-gradient(135deg, #1a0000, #330000);
            border: 3px dashed #ff4444;
            padding: 28px 20px;
            border-radius: 20px;
            color: #ff8888;
            font-size: 1.15em;
            text-align: center;
            position: relative;
            overflow: hidden;
            min-height: 180px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 16px;
            animation: pulse 3s infinite;
        }
        .seed-locked::before {
            content: '';
            position: absolute;
            top: -50%; left: -50%; width: 200%; height: 200%;
            background: repeating-linear-gradient(45deg, transparent, transparent 20px, rgba(255,68,68,0.03) 20px, rgba(255,68,68,0.03) 40px);
            animation: scanline 8s linear infinite;
        }
        @keyframes pulse { 0%,100%{box-shadow:0 0 20px rgba(255,68,68,0.4);} 50%{box-shadow:0 0 40px rgba(255,68,68,0.8);} }
        @keyframes scanline { 0%{transform:translateX(-50%) translateY(-50%);} 100%{transform:translateX(-50%) translateY(-50%) translateY(100%);} }
        .qr-icon { font-size: 52px; color: #ff6b00; animation: float 4s ease-in-out infinite; }
        @keyframes float { 0%,100%{transform:translateY(0);} 50%{transform:translateY(-12px);} }
        .waiting-text { font-weight: bold; color: #ffaaaa; letter-spacing: 1px; }
        .blink { animation: blink 1.5s infinite; }
        @keyframes blink { 0%,100%{opacity:1;} 50%{opacity:0.4;} }

        .btn {
            width: 100%;
            padding: 19px;
            font-size: 1.2em;
            font-weight: bold;
            border: none;
            border-radius: 60px;
            margin: 12px 0;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
        }
        .btn:hover { transform: translateY(-4px); box-shadow: 0 15px 40px rgba(0, 0, 0, 0.5); }
        .btn-scan { background: #0066ff; color: white; }
        .btn-scan:hover { background: #0052cc; }
        .btn-calon { background: #ff6b00; color: white; }
        .btn-calon:hover { background: #e55a00; }

        .loader {
            border: 6px solid #333;
            border-top: 6px solid #ff6b00;
            border-radius: 50%;
            width: 50px; height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); }

        .hidden { display: none !important; }
        .footer { text-align: center; margin-top: 40px; font-size: 0.95em; opacity: 0.8; line-height: 1.6; }

        /* Scanner & Permission (sama persis) */
        #permissionOverlay, #scannerOverlay, #errorPopup {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            display: none; align-items: center; justify-content: center;
            z-index: 9999; flex-direction: column; padding: 20px;
        }
        #permissionOverlay.active, #scannerOverlay.active, #errorPopup.active { display: flex; }
        #permissionOverlay { background: linear-gradient(135deg, #0f0019, #1a0033); z-index: 99999; }
        #scannerOverlay { background: #000; }
        #reader {
            width: 96%; max-width: 420px; height: 580px;
            border-radius: 30px; overflow: hidden;
            border: 9px solid #ff6b00; box-shadow: 0 0 90px rgba(255,107,0,0.9);
        }
        .closeScanner {
            position: absolute; top: 16px; right: 16px;
            background: rgba(255,0,68,0.9); color: white;
            width: 48px; height: 48px; border-radius: 50%; font-size: 22px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; z-index: 1000;
        }
        .closeScanner:hover { background: #ff0044; transform: scale(1.1); }

        @media(max-width:480px) {
            h1 { font-size: 2.1em; }
            .card { padding: 30px 20px; }
            #reader { height: 500px; }
        }
    </style>
</head>

<body>

    <!-- HALAMAN AWAL (TETAP 100% SAMA) -->
    <div id="mainView">
        <div class="card">
            <h1>Pilkades 2026</h1>
            <p class="subtitle">Desa SUKAMAJU • Voting Resmi</p>

            <div class="steps">
                Klik tombol <b>Scan QR Code Undangan</b> di bawah → izinkan akses kamera → arahkan ke <b>QR Code Undangan</b> dari panitia.
            </div>

            <div class="seed seed-locked" id="seedBox">
                <i class="fas fa-qrcode qr-icon"></i>
                <div class="waiting-text">
                    Menunggu scan <span class="blink">QR Code</span> undangan...
                </div>
            </div>

            <button class="btn btn-scan" id="scanBtn">
                <i class="fas fa-camera"></i> Scan QR Code Undangan
            </button>

            <div class="footer">
                Panitia Desa • Sistem Voting Blockchain 2026<br>
                Hubungi panitia jika ada kendala
            </div>
        </div>
    </div>

    <!-- IZIN KAMERA -->
    <div id="permissionOverlay">
        <div style="font-size:100px;color:#ff6b00;margin-bottom:24px;"><i class="fas fa-camera"></i></div>
        <div style="font-size:2.3em;font-weight:bold;color:#ff6b00;">Izinkan Kamera</div>
        <div style="font-size:1.15em;line-height:1.7;max-width:90%;margin:20px 0;text-align:center;">
            Aplikasi akan memindai QR Code undangan resmi.<br>
            <b>Kamera hanya digunakan saat scanning.</b><br>
            Tidak ada data yang disimpan.
        </div>
        <button class="btn" style="background:#ff6b00;color:white;" id="allowBtn">Izinkan Akses Kamera</button>
    </div>

    <!-- SCANNER -->
    <div id="scannerOverlay">
        <div class="closeScanner" id="closeScanner"><i class="fas fa-times"></i></div>
        <div id="reader"></div>
        <p style="margin-top:20px;color:#ff6b00;font-weight:bold;">Arahkan ke QR Code Undangan</p>
    </div>

    <!-- HALAMAN PILIH KANDIDAT (baru) -->
    <div id="voteView" class="hidden">
        <div class="card">
            <h1>Pilih Calon</h1>
            <p class="subtitle">Gunakan hak suara Anda dengan bijak</p>

            <div style="margin:30px 0;">
                <div style="background:#222;padding:20px;border-radius:16px;margin:16px 0;text-align:center;">
                    <h3>No. 1 - Ahmad Subardi</h3>
                    <button class="btn btn-calon" onclick="submitVote(1)">
                        <i class="fas fa-vote-yea"></i> Pilih Calon Nomor 1
                    </button>
                </div>
                <div style="background:#222;padding:20px;border-radius:16px;margin:16px 0;text-align:center;">
                    <h3>No. 2 - Siti Aminah</h3>
                    <button class="btn btn-calon" onclick="submitVote(2)">
                        <i class="fas fa-vote-yea"></i> Pilih Calon Nomor 2
                    </button>
                </div>
            </div>

            <div id="loadingVote" class="seed-locked" style="display:none;">
                <div class="loader"></div>
                <p><strong>Mengirim suara ke blockchain...</strong></p>
                <small>Jangan tutup halaman</small>
            </div>
        </div>
    </div>

    <!-- SUKSES -->
    <div id="successView" class="hidden">
        <div class="card">
            <h1>Terima Kasih!</h1>
            <p class="subtitle">Suara Anda telah tercatat di blockchain</p>
            <div style="text-align:center;margin:40px 0;">
                <i class="fas fa-check-circle" style="font-size:100px;color:#0f0;"></i>
            </div>
            <p style="text-align:center;font-size:1.2em;">
                Anda telah berpartisipasi dalam Pilkades Desa Sukamaju 2026<br>
                <strong>Suara Anda tidak dapat diubah lagi</strong>
            </p>
            <button class="btn" style="background:#0d8c0d;" onclick="location.reload()">
                Scan Undangan Lain
            </button>
        </div>
    </div>

    <!-- ERROR -->
    <div id="errorPopup>
        <div style="font-size:90px;color:#ff4444;margin-bottom:20px;"><i class="fas fa-times-circle"></i></div>
        <div style="font-size:2.3em;color:#ff6b00;font-weight:bold;">QR Code Tidak Valid</div>
        <div style="font-size:1.15em;line-height:1.8;max-width:90%;margin:20px 0;">
            Maaf, QR Code bukan undangan resmi Pilkades 2026.<br><br>
            Pastikan memindai <b>QR dari undangan kertas resmi panitia</b>.
        </div>
        <button class="btn btn-scan" onclick="location.reload()">
            <i class="fas fa-camera"></i> Coba Lagi
        </button>
    </div>

<script>
  // HARUS SAMA DENGAN DI generate.js !!!
  const RAHASIA_PANITIA = "SuperRahasia2026Pilkades";
  let voterWallet = null;

  // Tombol utama
  document.getElementById('scanBtn').onclick = () => 
    document.getElementById('permissionOverlay').classList.add('active');

  document.getElementById('allowBtn').onclick = () => {
    document.getElementById('permissionOverlay').classList.remove('active');
    document.getElementById('scannerOverlay').classList.add('active');
    startScanner();
  };

  document.getElementById('closeScanner').onclick = () => {
    document.getElementById('scannerOverlay').classList.remove('active');
    stopScanner();
  };

  let scanner = null;
  function startScanner() {
    stopScanner();
    scanner = new Html5Qrcode("reader");
    scanner.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: { width: 280, height: 280 } },
      onScanSuccess,
      () => {}
    ).catch(() => alert("Gagal akses kamera"));
  }
  function stopScanner() {
    if (scanner) scanner.stop().catch(() => {});
    scanner = null;
  }

  // PROSES QR YANG KAMU BUAT DI NODE.JS
  async function onScanSuccess(decodedText) {
    stopScanner();
    document.getElementById('scannerOverlay').classList.remove('active');

    let encrypted = decodedText.trim();

    // Kalau QR berisi URL[](https://pilkades-vote.vercel.app/?data=...)
    if (decodedText.includes('data=')) {
      try {
        const url = new URL(decodedText);
        encrypted = url.searchParams.get('data');
      } catch (e) {}
    }

    try {
      // Dekripsi
      const bytes = CryptoJS.AES.decrypt(encrypted, RAHASIA_PANITIA);
      const decrypted = bytes.toString(CryptoJS.enc.Utf8);
      const payload = JSON.parse(decrypted);

      // Verifikasi signature panitia
      const message = `${payload.address}${payload.voterId}SUKAMAJU2026`;
      const recoveredAddress = ethers.verifyMessage(ethers.toUtf8Bytes(message), payload.signature);

      if (recoveredAddress.toLowerCase() !== payload.address.toLowerCase()) {
        throw new Error("Signature panitia tidak cocok");
      }

      // Semua valid → buat wallet
      voterWallet = new ethers.Wallet(payload.privateKey);

      // Pindah ke halaman voting
      document.getElementById('mainView').classList.add('hidden');
      document.getElementById('voteView').classList.remove('hidden');

    } catch (err) {
      console.error(err);
      document.getElementById('errorPopup').classList.add('active');
    }
  }

  // VOTING (nanti tinggal ganti ke contract asli)
  async function submitVote(candidateNo) {
    document.getElementById('loadingVote').style.display = 'flex';

    // Simulasi kirim suara (ganti dengan Pimlico/Alchemy nanti)
    await new Promise(r => setTimeout(r, 3000));

    document.getElementById('voteView').classList.add('hidden');
    document.getElementById('successView').classList.remove('hidden');
  }
</script>

</body>
</html>
