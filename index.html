<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Pilkades 2025 - Voting Blockchain</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Segoe UI',sans-serif;background:#000;color:#fff;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:16px}
    .card{background:#111;width:100%;max-width:440px;border-radius:28px;padding:36px 28px;box-shadow:0 20px 60px rgba(255,107,0,0.25);border:1px solid rgba(255,107,0,0.15);position:relative;overflow:hidden}
    .card::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;background:linear-gradient(90deg,#ff6b00,#ff9f43)}
    h1{font-size:2.4em;text-align:center;margin-bottom:8px;color:#ff6b00;text-shadow:0 0 20px rgba(255,107,0,0.4)}
    .subtitle{text-align:center;font-size:1.15em;opacity:0.9;margin-bottom:24px 0}
    .steps{background:rgba(255,107,0,0.08);border:1px solid rgba(255,107,0,0.2);padding:20px;border-radius:18px;font-size:1.02em;line-height:1.85;margin:24px 0}
    .seed-locked{background:linear-gradient(135deg,#1a0000,#330000);border:3px dashed #ff4444;padding:28px 20px;border-radius:20px;color:#ff8888;font-size:1.15em;text-align:center;position:relative;overflow:hidden;min-height:180px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;animation:pulse 3s infinite}
    @keyframes pulse{0%,100%{box-shadow:0 0 20px rgba(255,68,68,0.4)}50%{box-shadow:0 0 40px rgba(255,68,68,0.8)}}
    .qr-icon{font-size:52px;color:#ff6b00;animation:float 4s ease-in-out infinite}
    @keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-12px)}}
    .waiting-text{font-weight:bold;color:#ffaaaa;letter-spacing:1px}
    .blink{animation:blink 1.5s infinite}
    @keyframes blink{0%,100%{opacity:1}50%{opacity:0.4}}
    .btn{width:100%;padding:19px;font-size:1.2em;font-weight:bold;border:none;border-radius:60px;margin:12px 0;cursor:pointer;transition:all .3s;display:flex;align-items:center;justify-content:center;gap:12px;box-shadow:0 10px 30px rgba(0,0,0,0.4)}
    .btn:hover{transform:translateY(-4px);box-shadow:0 15px 40px rgba(0,0,0,0.5)}
    .btn-scan{background:#0066ff;color:white}
    .btn-gallery{background:#2c3e50;color:white;margin-top:16px;font-size:1.1em;padding:16px;border:2px solid #34495e}
    .btn-gallery:hover{background:#34495e;border-color:#ff6b00}
    .closeScanner{position:absolute;top:16px;right:16px;background:rgba(255,0,68,0.9);color:white;width:48px;height:48px;border-radius:50%;font-size:22px;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 15px rgba(0,0,0,0.6);z-index:1000;cursor:pointer}
    .closeScanner:hover{background:#ff0044;transform:scale(1.1)}
    #reader{width:96%;max-width:420px;height:580px;border-radius:30px;overflow:hidden;border:9px solid #ff6b00;box-shadow:0 0 90px rgba(255,107,0,0.9)}
    .success{background:#0d8c0d;padding:30px;border-radius:20px;text-align:center;font-size:1.4em;margin-top:20px;animation:pulse2 2s infinite}
    @keyframes pulse2{0%,100%{transform:scale(1)}50%{transform:scale(1.03)}}
    .kandidat{background:#2d2d2d;color:white;padding:22px;margin:15px 0;border-radius:18px;font-size:1.3em;font-weight:bold;cursor:pointer;transition:0.3s;box-shadow:0 8px 25px rgba(0,0,0,0.4)}
    .kandidat:hover{background:#444;transform:scale(1.05)}
    #nikInput{width:90%;padding:16px;margin:20px 0;border:none;border-radius:12px;font-size:18px;text-align:center;background:#2d2d2d;color:white}
    #voteStatus{margin-top:20px;font-size:18px}
    #scannerOverlay{position:fixed;top:0;left:0;width:100%;height:100%;background:#000;display:none;align-items:center;justify-content:center;z-index:9999;flex-direction:column;padding:20px}
    #scannerOverlay.active{display:flex}
    #permissionOverlay{position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(135deg,#0f0019,#1a0033);display:none;align-items:center;justify-content:center;z-index:99999;flex-direction:column;padding:20px}
    #permissionOverlay.active{display:flex}
    .perm-icon{font-size:100px;color:#ff6b00;margin-bottom:24px;animation:glow 2s infinite}
    @keyframes glow{0%,100%{text-shadow:0 0 20px #ff6b00}50%{text-shadow:0 0 40px #ff6b00,0 0 60px #ff4500}}
    .perm-title{font-size:2.3em;font-weight:bold;color:#ff6b00;margin:10px 0}
    .perm-text{font-size:1.15em;line-height:1.7;max-width:90%;margin:20px 0}
    .perm-btn{background:#ff6b00;color:white;padding:20px 70px;font-size:1.3em;border-radius:60px;border:none;font-weight:bold;box-shadow:0 12px 40px rgba(255,107,0,0.5)}
    .perm-btn:hover{background:#e55a00;transform:scale(1.05)}
  </style>
</head>
<body>

  <div id="mainView">
    <div class="card">
      <h1>Pilkades 2025</h1>
      <p class="subtitle">Voting Elektronik Berbasis Blockchain</p>
      <div class="steps">
        Klik tombol <b>Scan QR Code Tiket</b> → arahkan ke tiket → masukkan NIK → pilih kandidat.
      </div>
      <div class="seed-locked">
        <i class="fas fa-qrcode qr-icon"></i>
        <div class="waiting-text">Menunggu scan <span class="blink">QR Code</span> tiket...</div>
      </div>
      <button class="btn btn-scan" id="scanBtn">
        <i class="fas fa-camera"></i> Scan QR Code Tiket
      </button>
    </div>
  </div>

  <div id="permissionOverlay">
    <div class="perm-icon"><i class="fas fa-camera"></i></div>
    <div class="perm-title">Izinkan Kamera</div>
    <div class="perm-text">
      Aplikasi akan memindai QR Code tiket resmi.<br>
      <b>Kamera hanya digunakan saat scanning.</b>
    </div>
    <button class="perm-btn" id="allowBtn">Izinkan Akses Kamera</button>
  </div>

  <div id="scannerOverlay">
    <div class="closeScanner" id="closeScanner">X</div>
    <div id="reader"></div>
    <button class="btn btn-gallery" id="galleryBtn">
      <i class="fas fa-images"></i> Pilih dari Galeri
    </button>
  </div>

  <input type="file" id="qrInput" accept="image/*" style="display:none;">

  <div id="voteView" style="display:none;">
    <div class="card">
      <h1>Pilih Kandidat</h1>
      <p class="subtitle">Tiket Anda valid!</p>
      <input type="text" id="nikInput" placeholder="Masukkan 16 digit NIK" maxlength="16">
      <div class="kandidat" onclick="vote(1)">1. H. Ahmad Subardi</div>
      <div class="kandidat" onclick="vote(2)">2. Hj. Siti Nurhaliza</div>
      <div class="kandidat" onclick="vote(3)">3. Budi Santoso, S.IP</div>
      <div id="voteStatus"></div>
    </div>
  </div>

  <script>
    const scannerOverlay = document.getElementById('scannerOverlay');
    const permissionOverlay = document.getElementById('permissionOverlay');
    const mainView = document.getElementById('mainView');
    const voteView = document.getElementById('voteView');
    const qrInput = document.getElementById('qrInput');
    const galleryBtn = document.getElementById('galleryBtn');
    let scanner = null;
    let qrToken = "";

    document.getElementById('scanBtn').onclick = () => permissionOverlay.classList.add('active');
    document.getElementById('allowBtn').onclick = () => {
      permissionOverlay.classList.remove('active');
      scannerOverlay.classList.add('active');
      startScanner();
    };
    document.getElementById('closeScanner').onclick = () => {
      scannerOverlay.classList.remove('active');
      stopScanner();
    };

    galleryBtn.onclick = () => qrInput.click();

    qrInput.onchange = e => {
      const file = e.target.files[0];
      if (!file) return;
      galleryBtn.innerHTML = 'Memproses...';
      const tempScanner = new Html5Qrcode("reader");
      tempScanner.scanFile(file, true)
        .then(text => processQR(text))
        .catch(() => {
          alert("QR tidak terbaca!");
          galleryBtn.innerHTML = '<i class="fas fa-images"></i> Pilih dari Galeri';
        });
    };

    function startScanner() {
      stopScanner();
      scanner = new Html5Qrcode("reader");
      scanner.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: { width: 280, height: 280 } },
        text => processQR(text),
        () => {}
      ).catch(() => alert("Gagal akses kamera"));
    }

    function stopScanner() {
      if (scanner) scanner.stop().catch(() => {});
      scanner = null;
    }

    function processQR(token) {
      qrToken = token.trim();
      stopScanner();
      scannerOverlay.classList.remove('active');
      mainView.style.display = 'none';
      voteView.style.display = 'block';
    }

    async function vote(candidateId) {
      const nik = document.getElementById('nikInput').value.trim();
      if (!/^\d{16}$/.test(nik)) {
        alert("NIK harus tepat 16 digit angka!");
        return;
      }

      document.getElementById('voteStatus').innerHTML = "Mengirim suara... (tunggu 10-20 detik)";

      const saltArray = crypto.getRandomValues(new Uint8Array(32));
      const salt = '0x' + Array.from(saltArray).map(b => b.toString(16).padStart(2,'0')).join('');

      try {
        const res = await fetch('http://localhost:3001/api/commit', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ qrToken, nik, candidateId, salt })
        });
        const data = await res.json();

        if (data.success) {
          document.getElementById('voteStatus').innerHTML = `
            <div class="success">
              TERIMA KASIH!<br>
              Suara Anda telah tercatat di blockchain!<br>
              <small>Tx: ${data.txHash.slice(0,12)}...</small>
            </div>`;
        } else {
          alert("Gagal: " + data.error);
        }
      } catch(e) {
        alert("Relayer mati! Jalankan: node backend/server.js");
      }
    }
  </script>
</body>
</html>
