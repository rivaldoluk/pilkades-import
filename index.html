<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Pilkades 2026 - Verifikasi Undangan</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.1/dist/ethers.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
  <style>
    /* Styling tetap sama seperti punya kamu, saya pertahankan 99% */
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #000; color: #fff;
      min-height: 100vh; display: flex; align-items: center; justify-content: center;
      padding: 16px;
    }
    .card {
      background: #111; width: 100%; max-width: 440px; border-radius: 28px;
      padding: 36px 28px; box-shadow: 0 20px 60px rgba(255, 107, 0, 0.25);
      border: 1px solid rgba(255, 107, 0, 0.15); position: relative; overflow: hidden;
    }
    .card::before {
      content:''; position:absolute; top:0; left:0; right:0; height:4px;
      background: linear-gradient(90deg, #ff6b00, #ff9f43);
    }
    h1 { font-size: 2.4em; text-align:center; margin-bottom:8px; color:#ff6b00; }
    .subtitle { text-align:center; font-size:1.15em; opacity:0.9; margin-bottom:24px; }
    .steps { background:rgba(255,107,0,0.08); border:1px solid rgba(255,107,0,0.2);
      padding:20px; border-radius:18px; line-height:1.85; margin:24px 0; }
    .btn {
      width:100%; padding:19px; font-size:1.2em; font-weight:bold; border:none;
      border-radius:60px; margin:12px 0; cursor:pointer; transition:all .3s;
      display:flex; align-items:center; justify-content:center; gap:12px;
    }
    .btn:hover { transform:translateY(-4px); }
    .btn-primary { background:#ff6b00; color:white; }
    .btn-primary:hover { background:#e55a00; }
    .footer { text-align:center; margin-top:40px; font-size:0.95em; opacity:0.8; }

    .success-icon { font-size:80px; color:#0f0; animation: float 3s infinite; }
    @keyframes float { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-15px)} }

    .warning { background:#330000; border:1px solid #660000; padding:16px; border-radius:12px; margin:20px 0; }
    .valid { color:#0f0; font-weight:bold; }

    /* Overlay styles tetap sama */
    #permissionOverlay, #scannerOverlay, #errorPopup, #loadingOverlay {
      position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.98);
      display:none; align-items:center; justify-content:center; flex-direction:column;
      z-index:99999; padding:20px; text-align:center;
    }
    #permissionOverlay.active, #scannerOverlay.active, #errorPopup.active, #loadingOverlay.active { display:flex; }
    #reader { width:96%; max-width:420px; height:580px; border:9px solid #ff6b00; border-radius:30px; overflow:hidden; }
    .closeScanner { position:absolute; top:16px; right:16px; background:rgba(255,0,68,0.9); color:white;
      width:48px; height:48px; border-radius:50%; display:flex; align-items:center; justify-content:center;
      font-size:22px; cursor:pointer; }
    .closeScanner:hover { background:#ff0044; }
  </style>
</head>
<body>

  <!-- HALAMAN AWAL -->
  <div id="mainView">
    <div class="card">
      <h1>Pilkades 2026</h1>
      <p class="subtitle">Desa Sukamaju</p>
      <div class="steps">
        Silakan scan <b>QR Code Undangan Resmi</b> yang diberikan panitia desa untuk memulai voting.
      </div>
      <button class="btn btn-primary" id="scanBtn">
        <i class="fas fa-camera"></i> Scan QR Undangan
      </button>
      <div class="footer">
        Panitia Desa Sukamaju • Pilkades Elektronik 2026
      </div>
    </div>
  </div>

  <!-- IZIN KAMERA -->
  <div id="permissionOverlay">
    <div style="font-size:100px;color:#ff6b00"><i class="fas fa-camera"></i></div>
    <div style="font-size:2.3em;font-weight:bold;color:#ff6b00;margin:20px 0;">Izinkan Kamera</div>
    <div style="font-size:1.2em;line-height:1.8;max-width:90%;">
      Aplikasi hanya akan menggunakan kamera untuk memindai QR Code undangan resmi.<br>
      <b>Tidak ada foto atau video yang disimpan.</b>
    </div>
    <button class="btn btn-primary" style="margin-top:30px;padding:20px 70px;font-size:1.3em;" id="allowBtn">
      Izinkan Kamera
    </button>
  </div>

  <!-- SCANNER -->
  <div id="scannerOverlay">
    <div class="closeScanner" id="closeScanner"><i class="fas fa-times"></i></div>
    <div id="reader"></div>
    <p style="margin-top:20px;color:#ff6b00;font-weight:bold;">
      Arahkan kamera ke QR Code undangan
    </p>
  </div>

  <!-- LOADING -->
  <div id="loadingOverlay">
    <div style="font-size:80px;color:#ff6b00;margin-bottom:20px;">
      <i class="fas fa-spinner fa-spin"></i>
    </div>
    <div style="font-size:1.5em;">Memverifikasi undangan...</div>
  </div>

  <!-- ERROR -->
  <div id="errorPopup">
    <div style="font-size:90px;color:#ff4444;"><i class="fas fa-times-circle"></i></div>
    <div style="font-size:2.3em;color:#ff6b00;margin:20px 0;font-weight:bold;">Undangan Tidak Valid</div>
    <div style="font-size:1.2em;line-height:1.8;max-width:90%;">
      QR Code yang discan <b>bukan undangan resmi</b> dari panitia Pilkades 2026.<br><br>
      Pastikan Anda memindai QR Code dari kertas undangan resmi.
    </div>
    <button class="btn btn-primary" style="margin-top:30px;" id="retryBtn">
      <i class="fas fa-camera"></i> Scan Ulang
    </button>
  </div>

  <!-- SUKSES & VOTING -->
  <div id="successView" style="display:none;">
    <div class="card">
      <h1>Pilkades 2026</h1>
      <p class="subtitle">Undangan Terverifikasi!</p>
      <div style="text-align:center;margin:30px 0;">
        <i class="fas fa-check-circle success-icon"></i>
      </div>

      <div class="steps">
        <div style="text-align:center;font-size:1.4em;margin-bottom:20px;">
          <div>Selamat datang,</div>
          <div style="color:#ff9f43;font-weight:bold;margin:10px 0;" id="voterName">Pemilih Resmi #<span id="voterId">-</span></div>
          <div class="valid"><i class="fas fa-shield-alt"></i> Undangan Anda <b>RESMI & VALID</b></div>
        </div>

        <hr style="border:1px dashed #333;margin:25px 0;">

        <div style="background:rgba(0,255,0,0.1);padding:16px;border-radius:12px;border:1px solid #0f0;">
          <i class="fas fa-vote-yea" style="color:#0f0;font-size:1.4em;"></i>
          <b>Anda sekarang dapat melakukan voting secara rahasia dan aman.</b>
        </div>

        <div class="warning">
          <i class="fas fa-exclamation-triangle"></i> Satu undangan hanya bisa digunakan <b>SEKALI</b> untuk voting.
        </div>
      </div>

      <button class="btn btn-primary" style="font-size:1.5em;padding:24px;" id="voteNowBtn">
        <i class="fas fa-paper-plane"></i> Voting Sekarang
      </button>

      <div class="footer">
        Panitia Desa Sukamaju • Sistem Voting Blockchain 2026<br>
        Hubungi panitia jika ada kendala
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <script>
    // ==== KONFIGURASI (SESUAIKAN DENGAN generate.js) ====
    const RAHASIA_PANITIA = "SuperRahasia2026Pilkades";
    const PANITIA_ADDRESS = "0x..."; // NANTI DIAMBIL OTOMATIS DARI PRIVATE KEY DI generate.js
    // Dari generate.js kamu: 0xce136693696197f531df8766ac2f2cd4e3587fb8db3091e19ce04f3920edc22a
    const EXPECTED_PANITIA_ADDRESS = "0xB4D619B7a5f2D6c3B8f1F8eD9b5D9b5D9b5D9b5D"; // GANTI DENGAN HASIL ethers.Wallet(privateKey).address

    // Hitung otomatis dari private key (lebih aman)
    const PANITIA_PRIVATE_KEY = "0xce136693696197f531df8766ac2f2cd4e3587fb8db3091e19ce04f3920edc22a";
    const panitiaWallet = new ethers.Wallet(PANITIA_PRIVATE_KEY);
    const PANITIA_ADDRESS_REAL = panitiaWallet.address; // ini yang benar

    let scanner = null;

    // Cek apakah sudah pernah vote
    function hasVoted() {
      return localStorage.getItem('hasVoted_2026') === 'true';
    }

    function markAsVoted() {
      localStorage.setItem('hasVoted_2026', 'true');
    }

    // Proses hasil scan
    async function processQR(url) {
      try {
        document.getElementById('loadingOverlay').classList.add('active');

        const urlObj = new URL(url);
        const encrypted = urlObj.searchParams.get('data');
        if (!encrypted) throw new Error("Tidak ada data");

        // Decrypt
        const decrypted = CryptoJS.AES.decrypt(encrypted, RAHASIA_PANITIA).toString(CryptoJS.enc.Utf8);
        const payload = JSON.parse(decrypted);

        // Validasi payload
        if (!payload.address || !payload.voterId || !payload.signature || payload.desa !== "SUKAMAJU") {
          throw new Error("Payload tidak lengkap");
        }

        // Verifikasi signature panitia
        const message = `${payload.address}${payload.voterId}${payload.desa}${payload.tahun}`;
        const recovered = ethers.verifyMessage(ethers.toUtf8Bytes(message), payload.signature);

        if (recovered.toLowerCase() !== PANITIA_ADDRESS_REAL.toLowerCase()) {
          throw new Error("Signature panitia tidak valid");
        }

        // Cek sudah vote belum
        if (hasVoted()) {
          alert("Undangan ini sudah digunakan untuk voting!");
          document.getElementById('loadingOverlay').classList.remove('active');
          return;
        }

        // SUKSES!
        document.getElementById('loadingOverlay').classList.remove('active');
        document.getElementById('mainView').style.display = 'none';
        document.getElementById('successView').style.display = 'block';
        document.getElementById('voterId').textContent = payload.voterId;

        // Simpan data voter sementara
        window.currentVoter = payload;

        // Tombol voting
        document.getElementById('voteNowBtn').onclick = () => {
          markAsVoted();
          // Ganti ke halaman voting sebenarnya
          window.location.href = `vote.html?voter=${payload.voterId}&addr=${payload.address}&key=${payload.privateKey}`;
          // Atau kalau 1 file: window.location.href = "#vote";
        };

      } catch (err) {
        console.error(err);
        document.getElementById('loadingOverlay').classList.remove('active');
        document.getElementById('errorPopup').classList.add('active');
      }
    }

    // Scanner logic (sama seperti sebelumnya)
    document.getElementById('scanBtn').onclick = () => {
      document.getElementById('permissionOverlay').classList.add('active');
    };

    document.getElementById('allowBtn').onclick = () => {
      document.getElementById('permissionOverlay').classList.remove('active');
      document.getElementById('scannerOverlay').classList.add('active');
      startScanner();
    };

    document.getElementById('closeScanner').onclick = () => {
      document.getElementById('scannerOverlay').classList.remove('active');
      stopScanner();
    };

    document.getElementById('retryBtn').onclick = () => {
      document.getElementById('errorPopup').classList.remove('active');
      document.getElementById('scannerOverlay').classList.add('active');
      startScanner();
    };

    function startScanner() {
      stopScanner();
      scanner = new Html5Qrcode("reader");
      scanner.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: { width: 280, height: 280 } },
        (text) => {
          stopScanner();
          document.getElementById('scannerOverlay').classList.remove('active');
          processQR(text);
        },
        () => {}
      ).catch(() => alert("Gagal akses kamera"));
    }

    function stopScanner() {
      if (scanner) {
        scanner.stop().catch(() => {});
        scanner = null;
      }
    }

    // Auto run jika URL sudah ada ?data=
    if (location.search.includes('data=')) {
      processQR(location.href);
    }
  </script>
</body>
</html>
