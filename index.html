<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Pilkades 2026 - Verifikasi Undangan</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.1/dist/ethers.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Segoe UI',sans-serif;background:#000;color:#fff;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:16px}
        .card{background:#111;width:100%;max-width:440px;border-radius:28px;padding:36px 28px;box-shadow:0 20px 60px rgba(255,107,0,0.25);border:1px solid rgba(255,107,0,0.15);position:relative;overflow:hidden}
        .card::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;background:linear-gradient(90deg,#ff6b00,#ff9f43)}
        h1{font-size:2.4em;text-align:center;margin-bottom:8px;color:#ff6b00;text-shadow:0 0 20px rgba(255,107,0,0.4)}
        .subtitle{text-align:center;font-size:1.15em;opacity:0.9;margin-bottom:24px}
        .steps{background:rgba(255,107,0,0.08);border:1px solid rgba(255,107,0,0.2);padding:20px;border-radius:18px;font-size:1.02em;line-height:1.85;margin:24px 0}
        .steps b{color:#ff9f43}
        .seed-locked{background:linear-gradient(135deg,#1a0000,#330000);border:3px dashed #ff4444;padding:28px 20px;border-radius:20px;color:#ff8888;font-size:1.15em;text-align:center;position:relative;overflow:hidden;min-height:180px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;animation:pulse 3s infinite}
        .seed-locked::before{content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:repeating-linear-gradient(45deg,transparent,transparent 20px,rgba(255,68,68,0.03) 20px,rgba(255,68,68,0.03) 40px);animation:scanline 8s linear infinite}
        @keyframes pulse{0%,100%{box-shadow:0 0 20px rgba(255,68,68,0.4)}50%{box-shadow:0 0 40px rgba(255,68,68,0.8)}}
        @keyframes scanline{0%{transform:translateX(-50%) translateY(-50%)}100%{transform:translateX(-50%) translateY(-50%) translateY(100%)}}
        .qr-icon{font-size:52px;color:#ff6b00;animation:float 4s ease-in-out infinite}
        @keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-12px)}}
        .waiting-text{font-weight:bold;color:#ffaaaa;letter-spacing:1px}
        .blink{animation:blink 1.5s infinite}
        @keyframes blink{0%,100%{opacity:1}50%{opacity:0.4}}
        .success-icon{font-size:80px;color:#0f0;animation:float 3s ease-in-out infinite}
        .btn{width:100%;padding:19px;font-size:1.2em;font-weight:bold;border:none;border-radius:60px;margin:12px 0;cursor:pointer;transition:all .3s;display:flex;align-items:center;justify-content:center;gap:12px;box-shadow:0 10px 30px rgba(0,0,0,0.4)}
        .btn:hover{transform:translateY(-4px);box-shadow:0 15px 40px rgba(0,0,0,0.5)}
        .btn-scan{background:#0066ff;color:white}
        .btn-scan:hover{background:#0052cc}
        .btn-primary{background:#ff6b00;color:white;font-size:1.5em;padding:24px}
        .btn-primary:hover{background:#e55a00}
        .btn-gallery{background:#2c3e50;color:white;margin-top:16px;padding:16px;border:2px solid #34495e}
        .btn-gallery:hover{background:#34495e;border-color:#ff6b00}
        .footer{text-align:center;margin-top:40px;font-size:0.95em;opacity:0.8;line-height:1.6}
        #permissionOverlay,#scannerOverlay,#errorPopup,#loadingOverlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.97);display:none;align-items:center;justify-content:center;flex-direction:column;z-index:99999;padding:20px;text-align:center}
        .active{display:flex !important}
        #reader{width:96%;max-width:420px;height:580px;border-radius:30px;overflow:hidden;border:9px solid #ff6b00;box-shadow:0 0 90px rgba(255,107,0,0.9)}
        .closeScanner{position:absolute;top:16px;right:16px;background:rgba(255,0,68,0.9);color:white;width:48px;height:48px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:22px;cursor:pointer;z-index:1000}
        .closeScanner:hover{background:#ff0044;transform:scale(1.1)}
        .perm-icon{font-size:100px;color:#ff6b00;margin-bottom:24px;animation:glow 2s infinite}
        @keyframes glow{0%,100%{text-shadow:0 0 20px #ff6b00}50%{text-shadow:0 0 40px #ff6b00,0 0 60px #ff4500}}
        .perm-title{font-size:2.3em;font-weight:bold;color:#ff6b00}
        .perm-text{font-size:1.15em;line-height:1.7;max-width:90%}
        .perm-btn{background:#ff6b00;color:white;padding:20px 70px;font-size:1.3em;border-radius:60px;border:none;font-weight:bold}
        .perm-btn:hover{background:#e55a00;transform:scale(1.05)}
        @media(max-width:480px){
            h1{font-size:2.1em}
            .card{padding:30px 20px}
            #reader{height:500px}
            .perm-icon{font-size:80px}
            .perm-title{font-size:2em}
        }
    </style>
</head>

<body>

    <!-- HALAMAN AWAL -->
    <div id="mainView">
        <div class="card">
            <h1>Pilkades 2026</h1>
            <p class="subtitle">Desa Sukamaju</p>

            <div class="steps">
                Klik tombol <b>Scan QR Code Undangan</b> → arahkan ke QR di undangan resmi dari panitia.
            </div>

            <div class="seed seed-locked">
                <i class="fas fa-qrcode qr-icon"></i>
                <div class="waiting-text">
                    Menunggu scan <span class="blink">QR Code</span> undangan...
                </div>
            </div>

            <button class="btn btn-scan" id="scanBtn">
                Scan QR Code Undangan
            </button>

            <div class="footer">
                Panitia Desa Sukamaju • Sistem Voting Blockchain 2026<br>
                Hubungi panitia jika ada kendala
            </div>
        </div>
    </div>

    <!-- IZIN KAMERA -->
    <div id="permissionOverlay">
        <div class="perm-icon">Kamera</div>
        <div class="perm-title">Izinkan Kamera</div>
        <div class="perm-text">
            Aplikasi akan memindai QR Code undangan resmi.<br>
            <b>Kamera hanya digunakan saat scanning.</b><br>
            Tidak ada data yang disimpan.
        </div>
        <button class="perm-btn" id="allowBtn">Izinkan Akses Kamera</button>
    </div>

    <!-- SCANNER -->
    <div id="scannerOverlay">
        <div class="closeScanner" id="closeScanner">X</div>
        <div id="reader"></div>
        <button class="btn btn-gallery" id="galleryBtn">
            Pilih dari Galeri
        </button>
        <p style="margin-top:20px;color:#ff6b00;font-weight:bold;">
            Arahkan kamera ke QR Code di undangan
        </p>
    </div>

    <input type="file" id="qrInput" accept="image/*" style="display:none;">

    <!-- LOADING -->
    <div id="loadingOverlay">
        <div style="font-size:80px;color:#ff6b00">Spinner</div>
        <p style="font-size:1.5em;margin-top:20px">Memverifikasi undangan resmi...</p>
    </div>

    <!-- ERROR -->
    <div id="errorPopup">
        <div style="font-size:90px;color:#ff4444;margin-bottom:20px;">X</div>
        <div style="font-size:2.3em;color:#ff6b00;font-weight:bold;">QR Code Tidak Valid</div>
        <div style="font-size:1.15em;line-height:1.8;max-width:90%;margin:20px 0;">
            Maaf, QR Code yang Anda scan <b>bukan undangan resmi Pilkades 2026</b>.<br><br>
            Pastikan Anda memindai <b>QR Code dari undangan kertas</b> yang diberikan panitia.
        </div>
        <button id="retryBtn" class="btn btn-scan">Coba Scan Lagi</button>
    </div>

    <!-- SUKSES -->
    <div id="successView" style="display:none;">
        <div class="card">
            <h1>Pilkades 2026</h1>
            <p class="subtitle">Undangan Resmi Terverifikasi!</p>

            <div style="text-align:center;margin:30px 0;">
                <i class="fas fa-check-circle success-icon"></i>
            </div>

            <div class="steps" style="text-align:center">
                <div style="font-size:1.6em;color:#ff9f43;font-weight:bold" id="voterId">Pemilih #---</div>
                <div style="margin:25px 0;padding:20px;background:#001100;border-radius:12px;border:1px solid #0f0">
                    <i class="fas fa-shield-alt" style="color:#0f0"></i>
                    <b>Identitas Anda telah diverifikasi sebagai pemilih sah</b>
                </div>
                <div style="color:#ff6b00;font-size:0.95em">
                    Satu undangan hanya dapat digunakan <b>SEKALI</b> untuk voting
                </div>
            </div>

            <button class="btn btn-primary" id="startVotingBtn">
                MULAI VOTING SEKARANG
            </button>

            <div class="footer">
                Panitia Desa Sukamaju • Sistem Voting Blockchain 2026<br>
                Terima kasih telah berpartisipasi!
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script>
        const RAHASIA_PANITIA = "SuperRahasia2026Pilkades";
        const PANITIA_ADDRESS = "0x1E61ED90b34EFfa858307071F1C11a5A5523F09f".toLowerCase();
        let scanner = null;
        let voterData = null;

        async function processQR(rawText) {
            try {
                document.getElementById('loadingOverlay').classList.add('active');

                const url = new URL(rawText.trim());
                const encrypted = url.searchParams.get('data');
                if (!encrypted) throw "Bukan QR resmi";

                const decrypted = CryptoJS.AES.decrypt(encrypted, RAHASIA_PANITIA).toString(CryptoJS.enc.Utf8);
                const payload = JSON.parse(decrypted);

                if (!payload.address || !payload.privateKey || !payload.voterId || !payload.signature) {
                    throw "Data tidak lengkap";
                }

                const messageHash = ethers.solidityPackedKeccak256(
                    ["address", "uint256", "string", "string"],
                    [payload.address, payload.voterId, payload.desa || "SUKAMAJU", payload.tahun || "2026"]
                );
                const signer = ethers.verifyMessage(ethers.getBytes(messageHash), payload.signature).toLowerCase();

                if (signer !== PANITIA_ADDRESS) throw "Tanda tangan panitia tidak valid";

                voterData = payload;

                document.getElementById('loadingOverlay').classList.remove('active');
                document.getElementById('mainView').style.display = 'none';
                document.getElementById('successView').style.display = 'block';
                document.getElementById('voterId').textContent = `Pemilih #${payload.voterId}`;

            } catch (err) {
                console.error(err);
                document.getElementById('loadingOverlay').classList.remove('active');
                document.getElementById('errorPopup').classList.add('active');
            }
        }

        if (location.search.includes('data=')) processQR(location.href);

        document.getElementById('scanBtn').onclick = () => 
            document.getElementById('permissionOverlay').classList.add('active');

        document.getElementById('allowBtn').onclick = () => {
            document.getElementById('permissionOverlay').classList.remove('active');
            document.getElementById('scannerOverlay').classList.add('active');
            startScanner();
        };

        document.getElementById('closeScanner').onclick = () => {
            document.getElementById('scannerOverlay').classList.remove('active');
            stopScanner();
        };

        document.getElementById('retryBtn').onclick = () => {
            document.getElementById('errorPopup').classList.remove('active');
            document.getElementById('scannerOverlay').classList.add('active');
            startScanner();
        };

        document.getElementById('galleryBtn').onclick = () => 
            document.getElementById('qrInput').click();

        document.getElementById('qrInput').onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const btn = document.getElementById('galleryBtn');
            btn.innerHTML = 'Memproses...';
            btn.disabled = true;

            try {
                const result = await Html5Qrcode.scanFileV2(file, true);
                await processQR(result.text);
            } catch (err) {
                alert("QR Code tidak terbaca. Pastikan gambar jelas dan gunakan QR resmi.");
            } finally {
                btn.innerHTML = 'Pilih dari Galeri';
                btn.disabled = false;
                e.target.value = '';
            }
        };

        function startScanner() {
            stopScanner();
            document.getElementById('reader').innerHTML = '';
            scanner = new Html5Qrcode("reader");
            scanner.start(
                { facingMode: "environment" },
                { fps: 10, qrbox: { width: 280, height: 280 } },
                (text) => {
                    stopScanner();
                    document.getElementById('scannerOverlay').classList.remove('active');
                    processQR(text);
                },
                () => {}
            ).catch(() => {
                alert("Gagal akses kamera");
                document.getElementById('scannerOverlay').classList.remove('active');
            });
        }

        function stopScanner() {
            if (scanner) scanner.stop().catch(() => {});
            scanner = null;
        }

        document.getElementById('startVotingBtn').onclick = () => {
            if (!voterData) return alert("Data hilang!");
            const params = new URLSearchParams({
                voterId: voterData.voterId,
                address: voterData.address,
                privateKey: voterData.privateKey
            });
            location.href = `vote.html?${params}`;
        };
    </script>
</body>
</html>
