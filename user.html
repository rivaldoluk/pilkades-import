<!DOCTYPE html>
<html lang="id">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pilkades Voting 2025</title>
  <script type="module">
    import config from './config.js';
    window.CONFIG = config;
  </script>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #4a148c;
      --success: #1b5e20;
      --danger: #d32f2f;
      --bg: #f8f9fa;
      --card: #ffffff;
      --border: #e0e0e0;
      --text: #333;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      color: var(--text);
    }

    .container {
      max-width: 600px;
      margin: 40px auto;
      background: var(--card);
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
      overflow: hidden;
    }

    .header {
      background: var(--primary);
      color: white;
      padding: 24px;
      text-align: center;
    }

    .header h1 {
      font-size: 26px;
      font-weight: 700;
    }

    .header p {
      opacity: 0.9;
      font-size: 16px;
    }

    .content {
      padding: 32px;
    }

    .status {
      text-align: center;
      padding: 14px;
      border-radius: 12px;
      font-weight: 600;
      margin-bottom: 20px;
    }

    .status.info {
      background: #e3f2fd;
      color: #1565c0;
    }

    .status.open {
      background: #e8f5e8;
      color: var(--success);
    }

    .status.closed {
      background: #ffebee;
      color: var(--danger);
    }

    button {
      width: 100%;
      padding: 16px;
      margin: 12px 0;
      font-size: 16px;
      font-weight: 600;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .connect-btn {
      background: #2196F3;
      color: white;
    }

    .connect-btn:hover {
      background: #1976D2;
    }

    .connect-btn:disabled {
      background: #555;
      cursor: not-allowed;
    }

    .vote-btn {
      background: #4CAF50;
      color: white;
    }

    .vote-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .candidate-btn {
      background: #f8f9fa;
      color: var(--text);
      border: 2px solid var(--border);
      padding: 16px;
      margin: 10px 0;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s;
      text-align: left;
    }

    .candidate-btn:hover:not(:disabled) {
      border-color: #4CAF50;
    }

    .candidate-btn.selected {
      background: #fff8e1;
      border-color: #ffb300;
      box-shadow: 0 0 0 3px rgba(255, 179, 0, 0.2);
    }

    .result {
      margin-top: 28px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 12px;
    }

    .countdown {
      color: var(--danger);
      font-weight: 700;
      font-size: 28px;
      text-align: center;
      margin: 16px 0;
    }

    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 12px;
      margin: 16px 0;
      flex-wrap: wrap;
    }

    .pagination button {
      width: auto;
      padding: 8px 16px;
      font-size: 14px;
      margin: 0;
    }

    .pagination span {
      font-weight: 600;
      color: var(--text);
    }

    .pemilih ul {
      list-style: none;
      max-height: 300px;
      overflow-y: auto;
      padding: 0;
      margin: 0;
      border: 1px solid #eee;
      border-radius: 8px;
      background: #fafafa;
    }

    .pemilih li {
      padding: 10px 12px;
      border-bottom: 1px solid #eee;
      font-family: 'Courier New', monospace;
      font-size: 13px;
    }

    .pemilih li:last-child {
      border-bottom: none;
    }

    .empty {
      text-align: center;
      padding: 20px;
      color: #777;
      font-style: italic;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>PILKADES 2025</h1>
      <p>Voting Aman, Transparan, & Gratis via Blockchain</p>
    </div>
    <div class="content">
      <div id="status" class="status info">Memuat...</div>
      <button id="connect" class="connect-btn">Connect MetaMask</button>

      <div id="voting" style="display:none; margin-top:24px;">
        <h3>Pilih Kandidat:</h3>
        <div id="candidates"></div>
        <button id="voteBtn" class="vote-btn" disabled>Pilih Dulu</button>
      </div>

      <div id="timer" class="countdown">-</div>

      <div class="result" id="result"></div>

      <div class="pemilih" style="margin-top:24px;">
        <h3>Daftar Semua Pemilih</h3>
        <div id="votersContainer">
          <ul id="pemilihListUl"></ul>
        </div>
        <div class="pagination" id="pagination" style="display:none;">
          <button id="prevBtn">Sebelumnya</button>
          <span id="pageInfo"></span>
          <button id="nextBtn">Berikutnya</button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import config from './config.js';
    const { CONTRACT_ADDRESS, RELAYER_URL, SEPOLIA_CHAIN_ID } = config;

    const ABI = [
      "function getKandidat() view returns (string[])",
      "function getHasil() view returns (uint256[])",
      "function getTotalPemilih() view returns (uint256)",
      "function statusVoting() view returns (string)",
      "function getWaktuTersisa() view returns (uint256)",
      "function getPemenang() view returns (uint256 index, string nama, uint256 suara)",
      "function sudahMemilih(address) view returns (bool)",
      "event VoteDariRelayer(address indexed pemilih, uint256 kandidatId)"
    ];

    let provider, signer, contract, account;
    let selectedId = null;
    let isVoting = false;
    let voteSuccessTimeout = null;
    let isShowingSuccess = false; // ← FLAG BARU!

    const ITEMS_PER_PAGE = 10;
    let allVoters = [];
    let currentPage = 1;
    let totalPages = 1;

    const statusEl = document.getElementById("status");
    const connectBtn = document.getElementById("connect");
    const votingDiv = document.getElementById("voting");
    const candidatesDiv = document.getElementById("candidates");
    const voteBtn = document.getElementById("voteBtn");
    const resultDiv = document.getElementById("result");
    const timerEl = document.getElementById("timer");
    const pemilihListUl = document.getElementById("pemilihListUl");
    const pagination = document.getElementById("pagination");
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");
    const pageInfo = document.getElementById("pageInfo");

    function setStatusMessage(message, type = "info") {
      statusEl.innerHTML = message;
      statusEl.className = `status ${type}`;
    }

    async function updateNormalStatus() {
      if (isShowingSuccess) return; // ← JANGAN GANGGU JIKA SEDANG VOTE BERHASIL!

      if (!account) {
        setStatusMessage("Siap! Klik Connect.", "info");
        return;
      }

      try {
        const [status, sudahVote] = await Promise.all([
          contract.statusVoting(),
          contract.sudahMemilih(account)
        ]);

        if (status === "Belum dibuka") {
          setStatusMessage("Voting belum dibuka.", "closed");
        } else if (status === "Selesai") {
          setStatusMessage(sudahVote ? "Anda sudah memilih." : "Voting selesai.", "closed");
        } else if (sudahVote) {
          setStatusMessage("Anda sudah memilih.", "open");
        } else {
          setStatusMessage("Silakan pilih kandidat.", "open");
        }
      } catch (err) {
        setStatusMessage("Gagal memuat status", "closed");
      }
    }

    if (!window.ethereum) {
      setStatusMessage("MetaMask tidak terdeteksi!", "closed");
      connectBtn.disabled = true;
    } else {
      setStatusMessage("Siap! Klik Connect MetaMask", "info");
      // JANGAN BUAT PROVIDER & CONTRACT DI SINI!
    }

    async function switchToSepolia() {
      try {
        await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: SEPOLIA_CHAIN_ID }] });
      } catch (err) {
        if (err.code === 4902) {
          await window.ethereum.request({
            method: 'wallet_addEthereumChain', params: [{
              chainId: SEPOLIA_CHAIN_ID,
              chainName: 'Sepolia Testnet',
              nativeCurrency: { name: 'Sepolia ETH', symbol: 'ETH', decimals: 18 },
              rpcUrls: ['https://rpc.sepolia.org'],
              blockExplorerUrls: ['https://sepolia.etherscan.io']
            }]
          });
        } else throw err;
      }
    }

    connectBtn.onclick = async () => {
      try {
        if ((await window.ethereum.request({ method: 'eth_chainId' })) !== SEPOLIA_CHAIN_ID) {
          await switchToSepolia();
        }

        // Baru request account
        await window.ethereum.request({ method: 'eth_requestAccounts' });

        // BARU DI SINI BUAT PROVIDER & CONTRACT (SUDAH PASTI SIAP!)
        provider = new ethers.providers.Web3Provider(window.ethereum);
        signer = provider.getSigner();
        account = await signer.getAddress();

        // Buat contract dengan signer (biar bisa baca sudahMemilih dll)
        contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);

        connectBtn.innerHTML = `Connected: ${account.slice(0, 6)}...${account.slice(-4)}`;
        connectBtn.disabled = true;
        votingDiv.style.display = "block";

        // Baru jalankan update pertama
        await loadCandidates();
        await updateStatus();
        await updateTimer();

        // Set interval setelah terhubung
        setInterval(updateStatus, 8000);
        setInterval(updateTimer, 1000);

      } catch (err) {
        console.error(err);
        setStatusMessage("Gagal connect: " + (err.message || "Coba lagi"), "closed");
      }
    };

    async function loadCandidates() {
      try {
        const [kandidat, sudahVote, status] = await Promise.all([
          contract.getKandidat(),
          account ? contract.sudahMemilih(account) : false,
          contract.statusVoting()
        ]);

        candidatesDiv.innerHTML = "";
        kandidat.forEach((nama, i) => {
          const btn = document.createElement("button");
          btn.className = "candidate-btn";
          btn.innerHTML = `<strong>${i + 1}. ${nama}</strong>`;
          btn.onclick = () => selectCandidate(i, btn);
          if (sudahVote || status !== "Berlangsung") btn.disabled = true;
          candidatesDiv.appendChild(btn);
        });

        voteBtn.disabled = sudahVote || status !== "Berlangsung" || isVoting;
        voteBtn.innerHTML = sudahVote ? "Sudah Vote" : status !== "Berlangsung" ? "Voting Selesai" : "Pilih Kandidat";
      } catch (err) {
        setStatusMessage("Gagal baca kontrak", "closed");
      }
    }

    function selectCandidate(id, btn) {
      document.querySelectorAll(".candidate-btn").forEach(b => b.classList.remove("selected"));
      btn.classList.add("selected");
      selectedId = id;
      voteBtn.disabled = isVoting;
      voteBtn.innerHTML = `Vote untuk ${btn.innerText.split(". ")[1]}`;
    }

    voteBtn.onclick = async () => {
      if (selectedId === null || isVoting) return;
      isVoting = true;
      voteBtn.disabled = true;
      voteBtn.innerHTML = "Tanda tangan...";

      try {
        const message = `vote:${selectedId}`;
        const messageHash = ethers.utils.keccak256(ethers.utils.toUtf8Bytes(message));
        const signature = await signer.signMessage(ethers.utils.arrayify(messageHash));

        voteBtn.innerHTML = "Kirim...";
        const res = await fetch(RELAYER_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ signature, kandidatId: selectedId, userAddress: account })
        });

        const data = await res.json();

        if (data.success) {
          // TAMPILKAN VOTE BERHASIL!
          isShowingSuccess = true;
          setStatusMessage(
            `VOTE BERHASIL! Tx: <a href="https://sepolia.etherscan.io/tx/${data.txHash}" target="_blank">${data.txHash.slice(0, 10)}...</a>`,
            "open"
          );

          // CLEAR TIMEOUT LAMA
          if (voteSuccessTimeout) clearTimeout(voteSuccessTimeout);

          // SETELAH 5 DETIK: GANTI KE "ANDA SUDAH MEMILIH"
          voteSuccessTimeout = setTimeout(async () => {
            isShowingSuccess = false;
            isVoting = false;
            setStatusMessage("Anda sudah memilih.", "open");
            await updateStatus(); // Update hasil + pemilih
            await loadCandidates();
            voteSuccessTimeout = null;
          }, 5000);

        } else if (data.error === "Sedang diproses") {
          voteBtn.innerHTML = "Antre...";
          const poll = setInterval(async () => {
            const sudahVote = await contract.sudahMemilih(account);
            if (sudahVote) {
              clearInterval(poll);
              isVoting = false;
              await updateStatus();
              await loadCandidates();
            }
          }, 3000);
        } else {
          throw new Error(data.error);
        }
      } catch (err) {
        setStatusMessage("Gagal: " + (err.message || "Coba lagi"), "closed");
        isVoting = false;
        voteBtn.disabled = false;
        voteBtn.innerHTML = "Coba Lagi";
      }
    };

    async function updateTimer() {
      try {
        const status = await contract.statusVoting();
        if (status !== "Berlangsung") {
          timerEl.textContent = status === "Selesai" ? "WAKTU HABIS!" : "-";
          return;
        }
        const sisa = await contract.getWaktuTersisa();
        const h = String(Math.floor(sisa / 3600)).padStart(2, '0');
        const m = String(Math.floor((sisa % 3600) / 60)).padStart(2, '0');
        const s = String(sisa % 60).padStart(2, '0');
        timerEl.textContent = `${h}:${m}:${s}`;
      } catch { timerEl.textContent = "-"; }
    }

    async function updateStatus() {
      try {
        const [hasil, total, status, pemenang, kandidat] = await Promise.all([
          contract.getHasil(),
          contract.getTotalPemilih(),
          contract.statusVoting(),
          contract.getPemenang(),
          contract.getKandidat()
        ]);

        let html = "<h3>HASIL SEMENTARA:</h3>";
        const maxVotes = Math.max(...hasil.map(v => Number(v))) || 1;

        kandidat.forEach((n, i) => {
          const votes = Number(hasil[i]);
          const pct = total > 0 ? (votes / total * 100).toFixed(1) : 0;
          const width = total > 0 ? (votes / maxVotes * 100) : 0;
          html += `<p><strong>${i + 1}. ${n}</strong>: <strong>${votes}</strong> suara (${pct}%)</p>
            <div style="height:8px;background:#e0e0e0;border-radius:4px;margin:8px 0;overflow:hidden;">
              <div style="width:${width}%;height:100%;background:#4CAF50;"></div>
            </div>`;
        });

        html += `<p><strong>Total Pemilih:</strong> ${total}</p><p><strong>Status:</strong> ${status}</p>`;
        if (status === "Selesai") html += `<p style="color:green;font-weight:700;">PEMENANG: ${pemenang[1]} (${pemenang[2]} suara)</p>`;

        resultDiv.innerHTML = html;

        // HANYA UPDATE STATUS JIKA TIDAK SEDANG MENAMPILKAN VOTE BERHASIL
        if (!isShowingSuccess) {
          await updateNormalStatus();
        }

        await loadAllVoters();
      } catch (err) {
        console.error(err);
      }
    }

    async function loadAllVoters() {
      try {
        const filter = contract.filters.VoteDariRelayer();
        const logs = await provider.getLogs({ ...filter, fromBlock: 0 });

        allVoters = logs.map(log => {
          const addr = "0x" + log.topics[1].slice(-40);
          return addr;
        }).reverse();

        totalPages = Math.ceil(allVoters.length / ITEMS_PER_PAGE);
        currentPage = 1;
        renderVoters();
      } catch (err) {
        pemilihListUl.innerHTML = "<li class='empty'>Gagal memuat pemilih</li>";
        pagination.style.display = "none";
      }
    }

    function renderVoters() {
      const start = (currentPage - 1) * ITEMS_PER_PAGE;
      const end = start + ITEMS_PER_PAGE;
      const pageVoters = allVoters.slice(start, end);

      if (pageVoters.length === 0) {
        pemilihListUl.innerHTML = "<li class='empty'>Belum ada pemilih</li>";
        pagination.style.display = "none";
        return;
      }

      pemilihListUl.innerHTML = pageVoters.map(addr =>
        `<li>${addr.slice(0, 8)}...${addr.slice(-6)}</li>`
      ).join("");

      pageInfo.textContent = `Hal ${currentPage} dari ${totalPages}`;
      prevBtn.disabled = currentPage === 1;
      nextBtn.disabled = currentPage === totalPages;
      pagination.style.display = "flex";
    }

    prevBtn.onclick = () => {
      if (currentPage > 1) {
        currentPage--;
        renderVoters();
      }
    };

    nextBtn.onclick = () => {
      if (currentPage < totalPages) {
        currentPage++;
        renderVoters();
      }
    };
  </script>
</body>

</html>
